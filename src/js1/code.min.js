"use strict";angular.module("myApp.controllers",[]).controller("optionCtrl",["$scope","$http",function(a,b){a.appid="",a.access_token=localStorage.access_token,a.uid=localStorage.uid,a.oAuthPath="",a.user=[],a.maxid=null,a.isloading=!1,a.timeline=new Array,a.authorize=function(){chrome.extension.getBackgroundPage().timeline=[],chrome.extension.getBackgroundPage().scrollTop=0,chrome.extension.getBackgroundPage().maxid=null,localStorage.access_token=null,localStorage.uid=null,a.oAuthPath="https://api.weibo.com/oauth2/authorize?client_id="+sinaApi.config.oauth_key+"&redirect_uri=https://api.weibo.com/oauth2/default.html&response_type=code",window.open(a.oAuthPath)},a.revokeoauth2=function(){var c="?access_token="+a.access_token;b({method:"GET",url:sinaApi.config.host+sinaApi.config.revokeoauth2+c}).success(function(){localStorage.access_token="",localStorage.uid="",a.user=[],chrome.extension.getBackgroundPage().timeline=[],chrome.extension.getBackgroundPage().scrollTop=0,chrome.extension.getBackgroundPage().maxid=null}).error(function(){})},chrome.tabs.onUpdated.addListener(function(b,c,d){if("loading"===c.status&&0===d.url.indexOf(sinaApi.config.oauth_callback+"?code=")){var e=d.url;e.indexOf("=")>0&&(e=e.substring(e.indexOf("=")+1)),a.$apply(a.appid=e),chrome.tabs.remove(b),a.gettoken()}}),a.gettoken=function(){var c="&code="+a.appid,d="https://api.weibo.com/oauth2/access_token?client_id="+sinaApi.config.oauth_key+"&client_secret="+sinaApi.config.oauth_secret+"&grant_type=authorization_code&redirect_uri=https://api.weibo.com/oauth2/default.html";b({method:"POST",url:d+c}).success(function(b){console.log(b),a.$apply(a.access_token=b.access_token),a.$apply(a.uid=b.uid),localStorage.access_token=b.access_token,localStorage.uid=b.uid,a.getuserinfo()}).error(function(b,c){a.data=b||"Request failed",a.status=c})},a.getuserinfo=function(){var d="?access_token="+a.access_token+"&uid="+a.uid;b({method:"GET",url:sinaApi.config.host+sinaApi.config.user_show+d}).success(function(b){a.user=[],a.user.push(b),localStorage.user=JSON.stringify(a.user)}).error(function(b,c){a.data=b||"Request failed",a.status=c})},void 0!=a.access_token&void 0!=a.uid&&a.getuserinfo(a.uid)}]).controller("weiboCtrl",["$scope","$http","sinaApi",function(a,b,c){console.log((new Date).getTime()),a.tabs={home:"home",at:"@",comments:"comments",favorites:"favorites",user:"user",follows:"follows"},a.oAuthPath="https://api.weibo.com/oauth2/authorize?client_id="+c.config.oauth_key+"&redirect_uri=https://api.weibo.com/oauth2/default.html&response_type=code",chrome.webRequest.onResponseStarted.addListener(function(b){var c=b.url;c.indexOf("=")>0&&(c=c.substring(c.indexOf("=")+1)),console.log(c),a.$apply(a.code=c),a.gettoken()},{urls:["https://api.weibo.com/oauth2/default.html*"]},["responseHeaders"]),a.suc=function(){},a.gettoken=function(){c.gettoken(code,function(){a.checkIsAuth()},function(a){console.debug(a)})},a.loadFriends=function(b){c.friends(b,function(b){0!=b.next_cursor&&a.loadFriends(b.next_cursor),$.each(b.users,function(b,c){a.atList[a.atList.length]={name:c.name,screen_name:c.screen_name}})},function(){console.debug(err)})},a.getuserinfo=function(b){c.user_show(b,function(b){a.user=[],a.user.push(b),localStorage.user=JSON.stringify(a.user),a.isAuth=!0,a.init()},function(){a.isAuth=!1,$("#oAuthIframe").attr("src",a.oAuthPath)})},a._timeline_suc=function(b,c){b.statuses.length>1&&("refresh"==c?(a.timeline=b.statuses,$("#warp").animate({scrollTop:0},300)):a.timeline=a.timeline.concat(b.statuses),a.maxid=b.statuses[b.statuses.length-1].id-1,chrome.extension.getBackgroundPage().timeline=a.timeline,chrome.extension.getBackgroundPage().scrollTop=0,chrome.extension.getBackgroundPage().maxid=a.maxid),a.loading=!1},a.get_mentions_timeline=function(b){a.loading=!0,c.mentions_timeline(a.maxid,function(c){a._timeline_suc(c,b),a.unreadAtNum=0,localStorage.unreadAtNum=0},function(){a.loading=!1})},a.get_comments_timeline=function(b){a.loading=!0,c.comments_timeline(a.maxid,function(c){for(var d in c.comments)c.comments[d].retweeted_status=c.comments[d].status;c.statuses=c.comments,a._timeline_suc(c,b),a.unreadCommentNum=0,localStorage.unreadCommentNum=0},function(){a.loading=!1})},a.get_favorites=function(b){a.loading=!0,c.favorites(a.maxid,function(c){c.statuses=[];for(var d in c.favorites)c.statuses[d]=c.favorites[d].status;a._timeline_suc(c,b)},function(){a.loading=!1})},a.get_home_timeline=function(b){a.loading=!0,c.home_timeline(a.maxid,function(c){a._timeline_suc(c,b),a.unreadTimeLineNum=0,localStorage.unreadTimeLineNum=0},function(){a.loading=!1})},a._handlePager=function(a,b){a.comments_pre_page=a.comments_next_page,a.comments_next_page=0,a.comments_pre_page=0,0!=b.next_cursor&&(a.comments_next_page=a.comments_page+1),0!=b.previous_cursor&&(a.comments_pre_page=a.comments_page-1)},a.get_repost=function(b,d){"pre"==d?b.comments_page=b.comments_pre_page:"next"==d&&(b.comments_page=b.comments_next_page),a.loading=!0,c.repost_timeline(b.id,b.comments_page,function(c){a.loading=!1,c.reposts.length>0&&(b.comments=c.reposts),a._handlePager(b,c),a.loading=!1},function(){a.loading=!1})},a.get_comments=function(b,d){"pre"==d?b.comments_page=b.comments_pre_page:"next"==d&&(b.comments_page=b.comments_next_page),a.loading=!0,c.get_comments(b.id,b.comments_page,function(c){a.loading=!1,c.comments.length>0&&(b.comments=c.comments),a._handlePager(b,c),a.loading=!1},function(){a.loading=!1})},a._send_suc=function(){Example.show("发送成功"),a.commentbox.comment_txt="",a.hideCommentText()},a._send_err=function(){Example.show("发送失败")},a.update=function(){a.commentbox.pic&&a.upload(),c.update(a.commentbox.comment_txt,function(){a._send_suc()},function(){a._send_err()})},a.upload=function(){c.upload(a.commentbox.comment_txt,a.commentbox.pic,function(){a._send_suc()},function(){a._send_err()})},a.reply=function(){c.reply(a.commentbox.comment_txt,a.commentbox.cid,a.commentbox.id,a.chk_also_comment_orig,function(){a._send_suc(),a.chk_also_comment_orig=!1},function(){a._send_err()})},a.comment=function(){c.post_comments(a.commentbox.comment_txt,a.commentbox.id,a.chk_also_repost,function(){a._send_suc(),a.chk_also_repost=!1},function(){a._send_err()})},a.repost=function(){var b=0;a.chk_also_comment&&(b=1),a.chk_also_comment_orig&&(b=2),a.chk_also_comment&a.chk_also_comment_orig&&(b=3),c.repost(a.commentbox.comment_txt,a.commentbox.id,b,function(){a._send_suc(),a.chk_also_comment=!1,a.chk_also_comment_orig=!1},function(){a._send_err()})},a.send=function(){"reply"==a.commentbox.type&&a.reply(),"create"==a.commentbox.type&&a.update(),"repost"==a.commentbox.type&&a.repost(),"comment"==a.commentbox.type&&a.comment()},a.favorite=function(a){c.favorite(a.id,a.favorited,function(){a.favorited=data.status.favorited,a.favorited?Example.show("收藏成功"):Example.show("移除收藏成功")},function(){Example.show("操作失败")})},a.categoryChange=function(b){a.current_category={category:b}},a.showCommentText=function(b,c){a.current_category={category:a.emotions_category[0]},a.commentbox.pic=null,a.commentbox.repost_with_retweet=!1,b&&(a.commentbox.id=b.id),a.commentbox.type=c,"repost"==c&&(a.commentbox.title="转发@"+b.user.name+"的微博",a.commentbox.comment_txt="转发微博//@"+b.user.name+":"+b.text,a.commentbox.button_txt="转发",b.retweeted_status&&(a.commentbox.repost_with_retweet=!0)),"comment"==c&&(a.commentbox.title="评论@"+b.user.name+"的微博",a.commentbox.comment_txt="",a.commentbox.button_txt="评论"),"reply"==c&&(a.commentbox.title="回复@"+b.user.name,a.commentbox.cid=b.id,a.commentbox.id=b.retweeted_status.id||b.status.id,a.commentbox.comment_txt="",a.commentbox.button_txt="回复"),"create"==c&&(a.commentbox.title="写微博",a.commentbox.comment_txt="",a.commentbox.button_txt="发送"),$("#comment_text_div").fadeIn()},a.hideCommentText=function(){$("#comment_text_div").fadeOut(),a.commentbox.pic=null,a.hideImgPop(),a.hideEmoPop(),a.chk_also_repost=!1,a.chk_also_comment=!1,a.chk_also_comment_orig=!1},a.showComments=function(b,c){"Comment"!=b.comment_type?($("#commentsdiv"+c).collapse("show"),b.comment_type="Comment",b.comments_page=1,a.get_comments(b,"")):$("#commentsdiv"+c).collapse("toggle")},a.showReComments=function(b,c){"Comment"!=b.comment_type?($("#recommentsdiv"+c).collapse("show"),b.comment_type="Comment",b.comments_page=1,a.get_comments(b,"")):$("#recommentsdiv"+c).collapse("toggle")},a.showRepost=function(b,c){"Repost"!=b.comment_type?($("#commentsdiv"+c).collapse("show"),b.comment_type="Repost",b.comments_page=1,a.get_repost(b,"")):$("#commentsdiv"+c).collapse("toggle")},a.showReRepost=function(b,c){"Repost"!=b.comment_type?($("#recommentsdiv"+c).collapse("show"),b.comment_type="Repost",b.comments_page=1,a.get_repost(b)):$("#recommentsdiv"+c).collapse("toggle")},a.loadHome=function(){$("a.active").removeClass("active"),$("#home_btn").addClass("active"),localStorage.current_icon="#home_btn",localStorage.current_tab=a.tabs.home,a.maxid=null,a.get_home_timeline("refresh")},a.loadComment=function(){$("a.active").removeClass("active"),$("#comment_btn").addClass("active"),localStorage.current_icon="#comment_btn",localStorage.current_tab=a.tabs.comments,a.maxid=null,a.get_comments_timeline("refresh")},a.loadAt=function(){$("a.active").removeClass("active"),$("#at_btn").addClass("active"),localStorage.current_icon="#at_btn",localStorage.current_tab=a.tabs.at,a.maxid=null,a.get_mentions_timeline("refresh")},a.loadFavorites=function(){$("a.active").removeClass("active"),$("#favorite_btn").addClass("active"),localStorage.current_icon="#favorite_btn",localStorage.current_tab=a.tabs.favorites,a.maxid=null,a.get_favorites("refresh")},a.get_timeline_next=function(){localStorage.current_tab==a.tabs.home&&a.get_home_timeline(),localStorage.current_tab==a.tabs.comments&&a.get_comments_timeline(),localStorage.current_tab==a.tabs.at&&a.get_mentions_timeline(),localStorage.current_tab==a.tabs.favorites&&a.get_favorites()},a.gotoOption=function(){chrome.extension.getOptions,chrome.tabs.create({url:"chrome-extension://pnkacoeejlfoikeaiobjennblgpoaaao/option.html",selected:!0},function(){})},a.hideinfo=function(){$("#infodiv").hide()},a.addItem2Editor=function(){},a.handleFileSelect=function(b){var c,e,d,f,g;if(console.log(b),b&&b.target.files)for(c=b.target.files,d=0;e=c[d];d++)e.type.match("image.*")&&(a.commentbox.pic=e,f=new FileReader,g=new FileReader,f.onload=function(a){return function(b){var c=document.createElement("span");c.innerHTML=['<img class="thumb" style="max-width: 200px;max-height: 200px" id="upload_img" src="',b.target.result,'" title="',escape(a.name),'"/>'].join(""),$("#uploadimg_div").show(),$("#selectImgBtn").popover("show"),$("#imglist")[0].innerHTML=c.innerHTML}}(e),g.onloadend=function(){var b=EXIF.readFromBinaryFile(new BinaryFile(this.result));"false"!=b&&a.insertText($("#comment_textarea")[0],buildExifStr(b))},f.readAsDataURL(e),g.readAsBinaryString(e))},a.insertText=function(b,c){var d,e,f,g,h;document.selection?(d=document.selection.createRange(),d.text=c):"number"==typeof b.selectionStart&&"number"==typeof b.selectionEnd?(e=b.selectionStart,f=b.selectionEnd,g=e,h=b.value,a.commentbox.comment_txt=h.substring(0,e)+c+h.substring(f,h.length),g+=c.length,b.selectionStart=b.selectionEnd=g):a.commentbox.comment_txt+=c},a.selectImg=function(){$("#files").click()},a.showEmotions=function(){$("#emotions_div").show(),$("#showEmotionsBtn").popover("toggle")},a.insertEmotion=function(b){a.insertText($("#comment_textarea")[0],b)},a.hideImgPop=function(){a.commentbox.pic=null,$("#selectImgBtn").popover("hide")},a.hideEmoPop=function(){$("#showEmotionsBtn").popover("hide")},a.checkIsAuth=function(){if(console.log((new Date).getTime()),a.isAuth=!0,a.uid=localStorage.uid,a.access_token=localStorage.access_token,console.log(a.uid),a.uid&&a.access_token)try{console.log(localStorage.user),a.currentuser=JSON.parse(localStorage.user),console.log((new Date).getTime()),a.init()}catch(b){console.log(b),a.getuserinfo(a.uid)}else a.isAuth=!1,$("#oAuthIframe").attr("src",a.oAuthPath)},a.init=function(){console.log("init"),a.api=c.config,a.unreadTimeLineNum=0,a.unreadCommentNum=0,a.unreadAtNum=0,a.appid="",a.oAuthPath="",a.maxid=null,a.isloading=!1,a.isAuth=!0,a.timeline=new Array,a.loading=!1,a.chk_also_comment=!1,a.chk_also_comment_orig=!1,a.chk_also_repost=!1,a.atList=[],a.commentbox={},a.currentPage=0,a.pageSize=5,console.log((new Date).getTime()),chrome.extension.getBackgroundPage().timeline&&chrome.extension.getBackgroundPage().timeline.length>0?(a.timeline=chrome.extension.getBackgroundPage().timeline,a.maxid=a.timeline[a.timeline.length-1].id,a.unreadTimeLineNum=localStorage.unreadTimeLineNum,a.unreadCommentNum=localStorage.unreadCommentNum,a.unreadAtNum=localStorage.unreadAtNum):(a.get_home_timeline(),localStorage.current_icon="#home_btn"),console.log((new Date).getTime())},a.checkIsAuth(),a.$on("ngRepeatFinished",function(){console.log("scroll to:"+chrome.extension.getBackgroundPage().scrollTop),$("#warp")[0].scrollTop=chrome.extension.getBackgroundPage().scrollTop,$("#selectImgBtn").popover({placement:"bottom",html:"true",content:$("#uploadimg_div"),trigger:"manual"}),$("#showEmotionsBtn").popover({placement:"bottom",html:"true",content:$("#emotions_div"),trigger:"manual"}),$("#warp").scroll(function(){var b=$("#warp").height(),c=$(this)[0].scrollHeight,d=$(this)[0].scrollTop;chrome.extension.getBackgroundPage().scrollTop=d,console.log("current position:"+d),d+b>=c&&0==a.loading&&(console.log("loadnewdata"),a.get_timeline_next())}),$("#files").on("change",function(b){a.handleFileSelect(b)}),localStorage.current_icon||(localStorage.current_icon="#home_btn"),$("a.active").removeClass("active"),$(localStorage.current_icon).addClass("active"),a.emotions=chrome.extension.getBackgroundPage().orig_emotions,a.emotions_category=chrome.extension.getBackgroundPage().emotions_category,a.$apply()}),setInterval(function(){a.$apply(a.unreadTimeLineNum=localStorage.unreadTimeLineNum)},5e3),a.$watch("commentbox.comment_txt",function(b){a.commentbox.lastCharNum=parseInt((280-getLength(b))/2)})}]);var Example=function(){var a,b,c={};return c.init=function(b){a=$(b.selector)},c.show=function(c){clearTimeout(b),a.find("span").html(c),a.delay(200).fadeIn().delay(4e3).fadeOut()},c}();Example.init({selector:".bb-alert"});